import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import * as THREE from 'three';

// --- SENİN KONFİGÜRASYONUN ---
const firebaseConfig = {
  apiKey: "AIzaSyDpGq40BwrP-GKNWuAwy5aLg5ja02RB0PU",
  authDomain: "eggapps-fb796.firebaseapp.com",
  projectId: "eggapps-fb796",
  storageBucket: "eggapps-fb796.firebasestorage.app",
  messagingSenderId: "60193983441",
  appId: "1:60193983441:web:b09e8ad860ab858e69aef0",
  measurementId: "G-P222SB4V1X"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// HTML Elementleri
const tabLogin = document.getElementById('tab-login');
const tabRegister = document.getElementById('tab-register');
const formLogin = document.getElementById('form-login');
const formRegister = document.getElementById('form-register');
const statusMsg = document.getElementById('status-msg');
const authContainer = document.getElementById('auth-container');
const gameUI = document.getElementById('game-ui');

// --- SEKME DEĞİŞTİRME ---
tabLogin.addEventListener('click', () => {
    tabLogin.classList.add('active');
    tabRegister.classList.remove('active');
    formLogin.style.display = 'block';
    formRegister.style.display = 'none';
    statusMsg.textContent = "";
});

tabRegister.addEventListener('click', () => {
    tabRegister.classList.add('active');
    tabLogin.classList.remove('active');
    formRegister.style.display = 'block';
    formLogin.style.display = 'none';
    statusMsg.textContent = "";
});

// --- GİRİŞ YAP (Login) ---
formLogin.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('login-email').value;
    const pass = document.getElementById('login-pass').value;
    
    statusMsg.textContent = "Giriş yapılıyor...";
    
    signInWithEmailAndPassword(auth, email, pass)
        .then((userCredential) => {
            statusMsg.textContent = "Başarılı!";
            // onAuthStateChanged otomatik yakalayacak
        })
        .catch((error) => {
            console.error(error);
            if (error.code === 'auth/invalid-credential') {
                statusMsg.textContent = "Hata: E-posta veya şifre yanlış.";
            } else if (error.code === 'auth/user-not-found') {
                statusMsg.textContent = "Hata: Böyle bir kullanıcı yok. Kayıt olun.";
            } else {
                statusMsg.textContent = "Hata: " + error.message;
            }
        });
});

// --- KAYIT OL (Register) ---
formRegister.addEventListener('submit', (e) => {
    e.preventDefault();
    const email = document.getElementById('reg-email').value;
    const pass = document.getElementById('reg-pass').value;

    statusMsg.textContent = "Hesap oluşturuluyor...";

    createUserWithEmailAndPassword(auth, email, pass)
        .then((userCredential) => {
            statusMsg.textContent = "Kayıt Başarılı! Veriler hazırlanıyor...";
            createUserData(userCredential.user);
        })
        .catch((error) => {
            console.error(error);
            if (error.code === 'auth/email-already-in-use') {
                statusMsg.textContent = "Bu E-posta zaten kullanılıyor.";
            } else if (error.code === 'auth/weak-password') {
                statusMsg.textContent = "Şifre çok zayıf (en az 6 karakter).";
            } else {
                statusMsg.textContent = "Kayıt Hatası: " + error.message;
            }
        });
});

// --- GOOGLE GİRİŞ ---
document.getElementById('btn-google').addEventListener('click', () => {
    statusMsg.textContent = "Google penceresi açılıyor...";
    const provider = new GoogleAuthProvider();
    
    signInWithPopup(auth, provider)
        .then((result) => {
            statusMsg.textContent = "Google girişi başarılı!";
            checkUserDatabase(result.user);
        })
        .catch((error) => {
            console.error("Google Auth Hatası:", error);
            if (error.code === 'auth/popup-closed-by-user') {
                statusMsg.textContent = "Pencereyi kapattınız.";
            } else if (error.code === 'auth/unauthorized-domain') {
                statusMsg.textContent = "Hata: Bu domain Firebase'de yetkili değil! (Localhost kullanın)";
            } else {
                statusMsg.textContent = "Google Hatası: " + error.message;
            }
        });
});

// --- KULLANICI DURUMU İZLEME ---
onAuthStateChanged(auth, (user) => {
    if (user) {
        // Kullanıcı giriş yapmış durumda
        checkUserDatabase(user);
    }
});

async function checkUserDatabase(user) {
    const userRef = doc(db, "users", user.uid);
    try {
        const userSnap = await getDoc(userRef);
        if (userSnap.exists()) {
            startGame(userSnap.data());
        } else {
            createUserData(user);
        }
    } catch (e) {
        console.error("Veritabanı hatası:", e);
        // Eğer veritabanı kuralları (rules) kapalıysa bu hata çıkar
    }
}

async function createUserData(user) {
    const userRef = doc(db, "users", user.uid);
    const newUserData = {
        email: user.email,
        money: 0,
        ammo: 100,
        tutorialComplete: false
    };
    await setDoc(userRef, newUserData);
    startGame(newUserData);
}

// --- OYUNU BAŞLAT ---
function startGame(userData) {
    authContainer.style.display = 'none';
    gameUI.style.display = 'block';
    
    // Bakiyeyi Yaz
    document.getElementById('money-disp').textContent = userData.money.toFixed(2);
    
    // Three.js başlat
    if (!window.gameInitialized) {
        init3D();
        animate();
        window.gameInitialized = true;
    }
}

// --- THREE.JS KISMI (Buradan sonrası aynı kalır, sadece değişkenleri global tanımlayalım) ---
let scene, camera, renderer, planeMesh;
let bullets = [];
// ... (Önceki kodun Three.js kısımlarını buraya ekle)
// Not: Kodun çok uzamaması için Three.js kısmını tekrar yazmadım, 
// önceki cevaptaki "init3D" ve "animate" fonksiyonlarını aynen kullanabilirsin.
// Ancak "init3D" fonksiyonunu yukarıda çağırdığımı unutma.

// Basit bir placeholder init3D örneği (Test için):
window.init3D = function() {
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
    renderer = new THREE.WebGLRenderer();
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);
    
    const geometry = new THREE.BoxGeometry();
    const material = new THREE.MeshBasicMaterial( { color: 0x00ff00 } );
    planeMesh = new THREE.Mesh( geometry, material );
    scene.add( planeMesh );
    camera.position.z = 5;
}

window.animate = function() {
    requestAnimationFrame( animate );
    planeMesh.rotation.x += 0.01;
    planeMesh.rotation.y += 0.01;
    renderer.render( scene, camera );
}
